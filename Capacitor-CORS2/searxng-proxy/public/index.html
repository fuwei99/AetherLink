<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bing ç½‘ç»œæœç´¢ CORS Bypass æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1, h2 {
            color: #333;
            margin-top: 0;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .result-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        
        .result-title {
            font-size: 18px;
            font-weight: bold;
            color: #1a0dab;
            margin-bottom: 5px;
        }
        
        .result-url {
            color: #006621;
            font-size: 14px;
            margin-bottom: 8px;
            word-break: break-all;
        }
        
        .result-content {
            color: #545454;
            line-height: 1.4;
        }
        
        .result-engine {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Bing ç½‘ç»œæœç´¢ CORS Bypass æµ‹è¯•</h1>
    <p style="background: #e7f3ff; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
        <strong>ğŸ¯ åŠŸèƒ½:</strong> é€šè¿‡ CORS ä»£ç†è®¿é—® Bing æœç´¢å¼•æ“è¿›è¡Œç½‘ç»œæœç´¢å’Œå†…å®¹æŠ“å–<br>
        <strong>ğŸ”§ æµ‹è¯•:</strong> éªŒè¯ Capacitor CORS Bypass æ’ä»¶çš„ç½‘ç»œæœç´¢èƒ½åŠ›
    </p>
    
    <div class="container">
        <h2>ğŸ“Š æœåŠ¡å™¨çŠ¶æ€</h2>
        <div id="serverStatus" class="status info">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkServerStatus()">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</button>
        <button onclick="testBing()">æµ‹è¯• Bing æœç´¢</button>
    </div>

    <div class="container">
        <h2>ğŸ” ç½‘ç»œæœç´¢æµ‹è¯•</h2>
        <div class="search-box">
            <input type="text" id="searchQuery" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." value="äººå·¥æ™ºèƒ½">
            <button onclick="performSearch()">æœç´¢</button>
        </div>
        
        <div class="controls">
            <select id="searchCategory">
                <option value="general">é€šç”¨</option>
                <option value="images">å›¾ç‰‡</option>
                <option value="videos">è§†é¢‘</option>
                <option value="news">æ–°é—»</option>
                <option value="map">åœ°å›¾</option>
                <option value="music">éŸ³ä¹</option>
                <option value="it">IT</option>
                <option value="science">ç§‘å­¦</option>
            </select>
            
            <select id="searchLanguage">
                <option value="zh-CN">ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
            
            <select id="searchFormat">
                <option value="json">JSON</option>
                <option value="html">HTML</option>
            </select>
        </div>
        
        <div id="searchResults"></div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>ğŸ“„ ç½‘é¡µå†…å®¹æŠ“å–</h2>
            <div class="search-box">
                <input type="text" id="fetchUrl" placeholder="è¾“å…¥è¦æŠ“å–çš„ç½‘é¡µ URL..." 
                       value="https://www.example.com">
                <button onclick="fetchContent()">æŠ“å–</button>
            </div>
            
            <div class="controls">
                <select id="extractType">
                    <option value="">å®Œæ•´å†…å®¹</option>
                    <option value="text">çº¯æ–‡æœ¬</option>
                    <option value="title">æ ‡é¢˜å’Œæè¿°</option>
                    <option value="links">é“¾æ¥</option>
                    <option value="images">å›¾ç‰‡</option>
                </select>
            </div>
            
            <div id="fetchResults"></div>
        </div>

        <div class="container">
            <h2>ğŸŒ CORS ä»£ç†æµ‹è¯•</h2>
            <div class="search-box">
                <input type="text" id="proxyUrl" placeholder="è¾“å…¥è¦ä»£ç†çš„ URL..." 
                       value="https://httpbin.org/json">
                <button onclick="testProxy()">æµ‹è¯•ä»£ç†</button>
            </div>
            <div id="proxyResults"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logs" class="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            try {
                log('æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...');
                const response = await fetch('/health');
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('serverStatus').className = 'status success';
                    document.getElementById('serverStatus').textContent =
                        `æœåŠ¡å™¨æ­£å¸¸ - æœç´¢å¼•æ“: ${data.searchEngine}`;
                    log(`æœåŠ¡å™¨å¥åº·æ£€æŸ¥æˆåŠŸ: ${JSON.stringify(data)}`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('serverStatus').className = 'status error';
                document.getElementById('serverStatus').textContent = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                log(`æœåŠ¡å™¨æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯• Bing æœç´¢
        async function testBing() {
            try {
                log('æµ‹è¯• Bing æœç´¢å¯ç”¨æ€§...');
                const response = await fetch('/test-bing');
                const data = await response.json();

                log(`Bing æµ‹è¯•ç»“æœ: ${data.status} (${data.responseTime || 'N/A'}ms)`);

                if (data.status === 'online') {
                    document.getElementById('serverStatus').className = 'status success';
                    document.getElementById('serverStatus').textContent =
                        `Bing æœç´¢æ­£å¸¸ - å“åº”æ—¶é—´: ${data.responseTime}ms`;
                } else {
                    document.getElementById('serverStatus').className = 'status error';
                    document.getElementById('serverStatus').textContent =
                        `Bing æœç´¢å¼‚å¸¸: ${data.error || data.status}`;
                }

            } catch (error) {
                log(`Bing æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const query = document.getElementById('searchQuery').value;
            const category = document.getElementById('searchCategory').value;
            const language = document.getElementById('searchLanguage').value;
            const format = document.getElementById('searchFormat').value;
            
            if (!query.trim()) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            try {
                log(`å¼€å§‹æœç´¢: "${query}" (${category}, ${language}, ${format})`);
                
                const url = new URL('/search', window.location.origin);
                url.searchParams.set('q', query);
                url.searchParams.set('category', category);
                url.searchParams.set('language', language);
                url.searchParams.set('format', format);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    displaySearchResults(data);
                    log(`æœç´¢æˆåŠŸ: æ‰¾åˆ° ${data.results?.length || 0} ä¸ªç»“æœ`);
                } else {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                log(`æœç´¢å¤±è´¥: ${error.message}`);
                document.getElementById('searchResults').innerHTML = 
                    `<div class="status error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(data) {
            const container = document.getElementById('searchResults');
            
            if (!data.results || data.results.length === 0) {
                container.innerHTML = '<div class="status info">æ²¡æœ‰æ‰¾åˆ°æœç´¢ç»“æœ</div>';
                return;
            }

            let html = `<div class="status success">æ‰¾åˆ° ${data.results.length} ä¸ªç»“æœ (æ¥æº: ${data.meta?.engine || 'Bing'})</div>`;
            
            data.results.forEach((result, index) => {
                html += `
                    <div class="result-item">
                        <div class="result-title">${escapeHtml(result.title)}</div>
                        <div class="result-url">${escapeHtml(result.url)}</div>
                        <div class="result-content">${escapeHtml(result.content || '')}</div>
                        ${result.engine ? `<div class="result-engine">æ¥æº: ${escapeHtml(result.engine)}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æŠ“å–ç½‘é¡µå†…å®¹
        async function fetchContent() {
            const url = document.getElementById('fetchUrl').value;
            const extractType = document.getElementById('extractType').value;
            
            if (!url.trim()) {
                alert('è¯·è¾“å…¥è¦æŠ“å–çš„ URL');
                return;
            }

            try {
                log(`å¼€å§‹æŠ“å–: ${url} (æå–: ${extractType || 'å®Œæ•´å†…å®¹'})`);
                
                const fetchUrl = new URL('/fetch', window.location.origin);
                fetchUrl.searchParams.set('url', url);
                if (extractType) {
                    fetchUrl.searchParams.set('extract', extractType);
                }
                
                const response = await fetch(fetchUrl);
                const data = await response.json();
                
                if (response.ok) {
                    displayFetchResults(data);
                    log(`æŠ“å–æˆåŠŸ: ${url}`);
                } else {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                log(`æŠ“å–å¤±è´¥: ${error.message}`);
                document.getElementById('fetchResults').innerHTML = 
                    `<div class="status error">æŠ“å–å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºæŠ“å–ç»“æœ
        function displayFetchResults(data) {
            const container = document.getElementById('fetchResults');
            
            let html = `<div class="status success">æŠ“å–æˆåŠŸ: ${data.url}</div>`;
            
            if (data.title) {
                html += `<h4>æ ‡é¢˜: ${escapeHtml(data.title)}</h4>`;
            }
            
            if (data.description) {
                html += `<p><strong>æè¿°:</strong> ${escapeHtml(data.description)}</p>`;
            }
            
            if (data.content) {
                html += `<p><strong>å†…å®¹:</strong> ${escapeHtml(data.content.substring(0, 500))}${data.content.length > 500 ? '...' : ''}</p>`;
            }
            
            if (data.links && data.links.length > 0) {
                html += `<h4>é“¾æ¥ (${data.links.length}):</h4><ul>`;
                data.links.slice(0, 10).forEach(link => {
                    html += `<li><a href="${escapeHtml(link.href)}" target="_blank">${escapeHtml(link.text)}</a></li>`;
                });
                html += '</ul>';
            }
            
            if (data.images && data.images.length > 0) {
                html += `<h4>å›¾ç‰‡ (${data.images.length}):</h4>`;
                data.images.slice(0, 5).forEach(img => {
                    html += `<p>ğŸ“· ${escapeHtml(img.src)} ${img.alt ? `(${escapeHtml(img.alt)})` : ''}</p>`;
                });
            }
            
            container.innerHTML = html;
        }

        // æµ‹è¯•ä»£ç†
        async function testProxy() {
            const url = document.getElementById('proxyUrl').value;
            
            if (!url.trim()) {
                alert('è¯·è¾“å…¥è¦ä»£ç†çš„ URL');
                return;
            }

            try {
                log(`æµ‹è¯•ä»£ç†: ${url}`);
                
                const response = await fetch(`/proxy/${url}`);
                const data = await response.text();
                
                document.getElementById('proxyResults').innerHTML = `
                    <div class="status success">ä»£ç†æˆåŠŸ (${response.status})</div>
                    <pre style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">${escapeHtml(data.substring(0, 1000))}${data.length > 1000 ? '\n...(truncated)' : ''}</pre>
                `;
                
                log(`ä»£ç†æˆåŠŸ: ${response.status} ${response.statusText}`);
            } catch (error) {
                log(`ä»£ç†å¤±è´¥: ${error.message}`);
                document.getElementById('proxyResults').innerHTML = 
                    `<div class="status error">ä»£ç†å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logs').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.addEventListener('load', () => {
            log('Bing Search CORS Bypass æµ‹è¯•é¡µé¢å·²åŠ è½½');
            checkServerStatus();
        });
    </script>
</body>
</html>
